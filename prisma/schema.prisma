// Prisma schema for Gather - Event Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  phone         String?   @unique @db.VarChar(20)
  passwordHash  String?   @map("password_hash") @db.VarChar(255)
  emailVerified Boolean   @default(false) @map("email_verified")
  phoneVerified Boolean   @default(false) @map("phone_verified")
  role          UserRole  @default(USER)
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  profile            Profile?
  sessions           Session[]
  events             Event[]            @relation("EventOrganizer")
  cohostedEvents     EventCoHost[]
  rsvps              Rsvp[]
  invitesSent        Invite[]           @relation("InviteSender")
  invitesReceived    Invite[]           @relation("InviteRecipient")
  notifications      Notification[]
  posts              Post[]
  comments           Comment[]
  reactions          Reaction[]
  reportsSubmitted   Report[]           @relation("ReportSubmitter")
  reportsReviewed    Report[]           @relation("ReportReviewer")
  blocksInitiated    Block[]            @relation("Blocker")
  blocksReceived     Block[]            @relation("Blocked")
  communities        CommunityMember[]
  communitiesCreated Community[]
  venuesCreated      Venue[]
  mediaUploaded      Media[]
  auditLogs          AuditLog[]
  rsvpApprovals      Rsvp[]             @relation("RsvpApprover")
  calendarTokens     CalendarToken[]
  magicLinkTokens    MagicLinkToken[]
  passwordResetTokens PasswordResetToken[]
  announcements      EventAnnouncement[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model Profile {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  displayName  String?  @map("display_name") @db.VarChar(100)
  username     String?  @unique @db.VarChar(50)
  bio          String?  @db.Text
  avatarUrl    String?  @map("avatar_url") @db.VarChar(500)
  timezone     String   @default("America/New_York") @db.VarChar(50)
  locale       String   @default("en-US") @db.VarChar(10)
  locationCity String?  @map("location_city") @db.VarChar(100)
  locationLat  Decimal? @map("location_lat") @db.Decimal(10, 8)
  locationLng  Decimal? @map("location_lng") @db.Decimal(11, 8)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([username])
  @@map("profiles")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  tokenHash    String   @unique @map("token_hash") @db.VarChar(64)
  deviceInfo   Json?    @map("device_info")
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model MagicLinkToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  email     String   @db.VarChar(255)
  tokenHash String   @unique @map("token_hash") @db.VarChar(64)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([email])
  @@map("magic_link_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash") @db.VarChar(64)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ============ EVENTS ============

model Event {
  id              String       @id @default(uuid()) @db.Uuid
  organizerId     String       @map("organizer_id") @db.Uuid
  communityId     String?      @map("community_id") @db.Uuid
  venueId         String?      @map("venue_id") @db.Uuid

  title           String       @db.VarChar(200)
  slug            String       @unique @db.VarChar(250)
  description     String?      @db.Text
  coverImageUrl   String?      @map("cover_image_url") @db.VarChar(500)

  startTime       DateTime     @map("start_time")
  endTime         DateTime?    @map("end_time")
  timezone        String       @db.VarChar(50)

  isOnline        Boolean      @default(false) @map("is_online")
  onlineUrl       String?      @map("online_url") @db.VarChar(500)
  locationName    String?      @map("location_name") @db.VarChar(200)
  locationAddress String?      @map("location_address") @db.VarChar(500)
  locationLat     Decimal?     @map("location_lat") @db.Decimal(10, 8)
  locationLng     Decimal?     @map("location_lng") @db.Decimal(11, 8)
  locationHidden  Boolean      @default(true) @map("location_hidden")

  privacy         EventPrivacy @default(PRIVATE)
  requireApproval Boolean      @default(false) @map("require_approval")
  allowPlusOnes   Boolean      @default(true) @map("allow_plus_ones")
  maxPlusOnes     Int          @default(5) @map("max_plus_ones")
  capacity        Int?
  enableWaitlist  Boolean      @default(true) @map("enable_waitlist")
  enableComments  Boolean      @default(true) @map("enable_comments")
  guestListVisible Boolean     @default(true) @map("guest_list_visible")

  isRecurring     Boolean      @default(false) @map("is_recurring")
  recurrenceRule  String?      @map("recurrence_rule") @db.VarChar(500)
  parentEventId   String?      @map("parent_event_id") @db.Uuid

  status          EventStatus  @default(DRAFT)
  category        String?      @db.VarChar(50)

  viewCount       Int          @default(0) @map("view_count")

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  publishedAt     DateTime?    @map("published_at")
  cancelledAt     DateTime?    @map("cancelled_at")
  deletedAt       DateTime?    @map("deleted_at")

  // Relations
  organizer       User         @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)
  community       Community?   @relation(fields: [communityId], references: [id], onDelete: SetNull)
  venue           Venue?       @relation(fields: [venueId], references: [id], onDelete: SetNull)
  parentEvent     Event?       @relation("EventChildren", fields: [parentEventId], references: [id], onDelete: Cascade)
  childEvents     Event[]      @relation("EventChildren")
  occurrences     EventOccurrence[]
  cohosts         EventCoHost[]
  rsvps           Rsvp[]
  invites         Invite[]
  posts           Post[]
  reports         Report[]     @relation("ReportedEvent")
  announcements   EventAnnouncement[]

  @@index([organizerId])
  @@index([slug])
  @@index([startTime])
  @@index([status, privacy])
  @@index([category])
  @@index([communityId])
  @@index([parentEventId])
  @@map("events")
}

model EventOccurrence {
  id              String              @id @default(uuid()) @db.Uuid
  eventId         String              @map("event_id") @db.Uuid
  occurrenceIndex Int                 @map("occurrence_index")

  startTime       DateTime            @map("start_time")
  endTime         DateTime?           @map("end_time")

  status          OccurrenceStatus    @default(SCHEDULED)
  overrideData    Json?               @map("override_data")

  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  event           Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  rsvps           Rsvp[]

  @@unique([eventId, occurrenceIndex])
  @@index([eventId])
  @@index([startTime])
  @@map("event_occurrences")
}

model EventAnnouncement {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @map("event_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  title     String?  @db.VarChar(200)
  message   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([authorId])
  @@map("event_announcements")
}

model Venue {
  id          String   @id @default(uuid()) @db.Uuid
  createdBy   String   @map("created_by") @db.Uuid
  name        String   @db.VarChar(200)
  address     String?  @db.VarChar(500)
  city        String?  @db.VarChar(100)
  state       String?  @db.VarChar(100)
  country     String?  @db.VarChar(100)
  postalCode  String?  @map("postal_code") @db.VarChar(20)
  lat         Decimal? @db.Decimal(10, 8)
  lng         Decimal? @db.Decimal(11, 8)
  placeId     String?  @map("place_id") @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  creator     User     @relation(fields: [createdBy], references: [id])
  events      Event[]

  @@map("venues")
}

model EventCoHost {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @map("event_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  permissions Json     @default("{\"edit\": true, \"invite\": true, \"manage_guests\": true}")
  createdAt   DateTime @default(now()) @map("created_at")

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@map("event_cohosts")
}

// ============ RSVP & INVITES ============

model Rsvp {
  id            String           @id @default(uuid()) @db.Uuid
  eventId       String           @map("event_id") @db.Uuid
  occurrenceId  String?          @map("occurrence_id") @db.Uuid
  userId        String           @map("user_id") @db.Uuid

  status        RsvpStatus
  plusOnes      Int              @default(0) @map("plus_ones")

  approved      Boolean          @default(true)
  approvedAt    DateTime?        @map("approved_at")
  approvedBy    String?          @map("approved_by") @db.Uuid

  checkedIn     Boolean          @default(false) @map("checked_in")
  checkedInAt   DateTime?        @map("checked_in_at")

  invitedBy     String?          @map("invited_by") @db.Uuid
  inviteId      String?          @map("invite_id") @db.Uuid

  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  event         Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  occurrence    EventOccurrence? @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver      User?            @relation("RsvpApprover", fields: [approvedBy], references: [id])
  invite        Invite?          @relation(fields: [inviteId], references: [id])

  @@unique([eventId, userId, occurrenceId])
  @@index([eventId])
  @@index([userId])
  @@index([eventId, status])
  @@index([occurrenceId])
  @@map("rsvps")
}

model Invite {
  id          String       @id @default(uuid()) @db.Uuid
  eventId     String       @map("event_id") @db.Uuid
  invitedBy   String       @map("invited_by") @db.Uuid

  token       String       @unique @db.VarChar(100)
  type        InviteType   @default(STANDARD)

  email       String?      @db.VarChar(255)
  phone       String?      @db.VarChar(20)
  userId      String?      @map("user_id") @db.Uuid

  status      InviteStatus @default(PENDING)
  message     String?      @db.Text

  sentAt      DateTime?    @map("sent_at")
  openedAt    DateTime?    @map("opened_at")
  respondedAt DateTime?    @map("responded_at")
  expiresAt   DateTime?    @map("expires_at")

  createdAt   DateTime     @default(now()) @map("created_at")

  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sender      User         @relation("InviteSender", fields: [invitedBy], references: [id])
  recipient   User?        @relation("InviteRecipient", fields: [userId], references: [id])
  rsvps       Rsvp[]

  @@index([eventId])
  @@index([token])
  @@index([email])
  @@map("invites")
}

// ============ POSTS & INTERACTIONS ============

model Post {
  id        String    @id @default(uuid()) @db.Uuid
  eventId   String    @map("event_id") @db.Uuid
  authorId  String    @map("author_id") @db.Uuid

  type      PostType  @default(UPDATE)
  content   String    @db.Text
  isPinned  Boolean   @default(false) @map("is_pinned")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id])
  comments  Comment[]
  reactions Reaction[]
  media     Media[]

  @@index([eventId])
  @@index([eventId, isPinned])
  @@map("posts")
}

model Comment {
  id        String    @id @default(uuid()) @db.Uuid
  postId    String    @map("post_id") @db.Uuid
  authorId  String    @map("author_id") @db.Uuid
  parentId  String?   @map("parent_id") @db.Uuid

  content   String    @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([parentId])
  @@map("comments")
}

model Reaction {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  emoji     String   @db.VarChar(10)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@map("reactions")
}

model Media {
  id           String    @id @default(uuid()) @db.Uuid
  uploadedBy   String    @map("uploaded_by") @db.Uuid
  url          String    @db.VarChar(500)
  thumbnailUrl String?   @map("thumbnail_url") @db.VarChar(500)
  type         MediaType
  mimeType     String?   @map("mime_type") @db.VarChar(100)
  sizeBytes    Int?      @map("size_bytes")
  width        Int?
  height       Int?
  altText      String?   @map("alt_text") @db.VarChar(500)

  entityType   String    @map("entity_type") @db.VarChar(50)
  entityId     String    @map("entity_id") @db.Uuid

  createdAt    DateTime  @default(now()) @map("created_at")

  uploader     User      @relation(fields: [uploadedBy], references: [id])
  post         Post?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@map("media")
}

// ============ COMMUNITIES ============

model Community {
  id            String    @id @default(uuid()) @db.Uuid
  createdBy     String    @map("created_by") @db.Uuid
  name          String    @db.VarChar(200)
  slug          String    @unique @db.VarChar(200)
  description   String?   @db.Text
  coverImageUrl String?   @map("cover_image_url") @db.VarChar(500)
  privacy       CommunityPrivacy @default(PUBLIC)
  memberCount   Int       @default(0) @map("member_count")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  creator       User      @relation(fields: [createdBy], references: [id])
  members       CommunityMember[]
  events        Event[]

  @@index([slug])
  @@map("communities")
}

model CommunityMember {
  id          String        @id @default(uuid()) @db.Uuid
  communityId String        @map("community_id") @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now()) @map("joined_at")

  community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
  @@map("community_members")
}

// ============ NOTIFICATIONS ============

model Notification {
  id         String             @id @default(uuid()) @db.Uuid
  userId     String             @map("user_id") @db.Uuid
  type       String             @db.VarChar(50)
  title      String             @db.VarChar(200)
  body       String?            @db.Text
  entityType String?            @map("entity_type") @db.VarChar(50)
  entityId   String?            @map("entity_id") @db.Uuid
  channel    NotificationChannel
  status     NotificationStatus @default(PENDING)
  readAt     DateTime?          @map("read_at")
  sentAt     DateTime?          @map("sent_at")
  createdAt  DateTime           @default(now()) @map("created_at")

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, readAt])
  @@index([status, channel])
  @@map("notifications")
}

// ============ MODERATION ============

model Report {
  id          String       @id @default(uuid()) @db.Uuid
  reporterId  String       @map("reporter_id") @db.Uuid
  entityType  String       @map("entity_type") @db.VarChar(50)
  entityId    String       @map("entity_id") @db.Uuid
  reason      ReportReason
  details     String?      @db.Text
  status      ReportStatus @default(PENDING)
  reviewedBy  String?      @map("reviewed_by") @db.Uuid
  reviewedAt  DateTime?    @map("reviewed_at")
  actionTaken String?      @map("action_taken") @db.VarChar(100)
  createdAt   DateTime     @default(now()) @map("created_at")

  reporter    User         @relation("ReportSubmitter", fields: [reporterId], references: [id])
  reviewer    User?        @relation("ReportReviewer", fields: [reviewedBy], references: [id])
  event       Event?       @relation("ReportedEvent", fields: [entityId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([entityType, entityId])
  @@map("reports")
}

model Block {
  id        String   @id @default(uuid()) @db.Uuid
  blockerId String   @map("blocker_id") @db.Uuid
  blockedId String   @map("blocked_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("blocks")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Uuid
  oldData    Json?    @map("old_data")
  newData    Json?    @map("new_data")
  metadata   Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============ CALENDAR ============

model CalendarToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("calendar_tokens")
}

// ============ ENUMS ============

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum EventPrivacy {
  PRIVATE
  UNLISTED
  PUBLIC
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum OccurrenceStatus {
  SCHEDULED
  CANCELLED
}

enum RsvpStatus {
  GOING
  MAYBE
  NOT_GOING
  WAITLIST
}

enum InviteType {
  STANDARD
  VIP
}

enum InviteStatus {
  PENDING
  SENT
  OPENED
  RESPONDED
  EXPIRED
}

enum PostType {
  UPDATE
  ANNOUNCEMENT
  QUESTION
}

enum MediaType {
  IMAGE
  VIDEO_LINK
}

enum CommunityPrivacy {
  PUBLIC
  PRIVATE
}

enum CommunityRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum NotificationChannel {
  EMAIL
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  FAKE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
  DISMISSED
}
